# Audio Transition Smoothing Plan

## Problem Summary

When listening to the final MP3, users perceive:
1. **Sharp cuts** between audio segments - abrupt transitions
2. **"Air leaving the space"** - stark contrast between speech (natural noise floor) and digital silence (0 samples)
3. **Big emptiness** - programmatic silence sounds unnatural compared to room tone

## Root Cause Analysis

Analysis of `fr.mp3` reveals:
- **Digital silence**: RMS = `-inf` (true zero samples) between segments
- **Sharp transitions**: Goes from `-inf` → `-29.5 dB` → `-17 dB` in just 50-100ms
- **Inadequate crossfade**: Current 25ms `CROSSFADE_MS` is too short to mask transitions
- **No per-segment fades**: TTS segments have abrupt starts/stops

## Solution Overview

Implement professional audio production techniques:

1. **Replace digital silence with comfort noise** (~-55 dB pink noise)
2. **Increase crossfade duration** from 25ms to 75ms
3. **Use logarithmic fade curves** instead of linear
4. **Apply per-segment fade in/out** (15ms in, 25ms out)
5. **Analyze and match TTS noise floor** for consistency

## Implementation Details

### File: `generate_audio.py`

#### 1. Update Constants (Lines 49-65)

```python
# Updated constants
CROSSFADE_MS = 75  # Increased from 25ms
SEGMENT_FADE_IN_MS = 15  # New: fade at segment start
SEGMENT_FADE_OUT_MS = 25  # New: fade at segment end
COMFORT_NOISE_LEVEL_DB = -55  # New: target noise floor
```

#### 2. Add New Import

```python
import numpy as np
```

#### 3. Add `generate_comfort_noise()` Function (After line 830)

Creates pink noise (1/f spectrum) instead of digital silence:
- Takes duration, target dB level, and optional reference audio
- Uses pink noise which sounds more natural than white noise
- Applies micro-fades to prevent clicks at edges

#### 4. Add `analyze_noise_floor()` Function

Analyzes TTS segments to determine their inherent noise floor:
- Examines quietest portions of audio
- Returns noise floor level in dBFS
- Used to generate matching comfort noise

#### 5. Enhance `apply_crossfade()` Function (Lines 953-983)

Add support for non-linear fade curves:
- **logarithmic**: Slower start, faster end (natural decay)
- **exponential**: Faster start, slower end (natural attack)
- **s_curve**: Smoothest perceived transition

#### 6. Update `normalize_segment_audio()` Function (Lines 794-829)

Add per-segment fades and comfort noise buffers:
- Apply `fade_in()` and `fade_out()` to trimmed speech
- Replace silent buffers with comfort noise
- Pass reference audio for noise floor matching

#### 7. Update `concatenate_segment_audio()` Function (Lines 986-1096)

Enhanced processing pipeline:
1. Convert PCM to AudioSegment
2. Analyze overall noise floor across all segments
3. Normalize each segment with comfort noise buffers and fades
4. Create pauses using comfort noise instead of silence
5. Apply crossfades with logarithmic curves
6. Add file-level comfort noise for leading/trailing

#### 8. Extend `PauseConfig` Dataclass (Lines 169-203)

Add new configuration fields:
```python
use_comfort_noise: bool = True
comfort_noise_db: float = -55.0
crossfade_curve: str = "logarithmic"
segment_fade_in_ms: int = 15
segment_fade_out_ms: int = 25
```

## Parameter Recommendations

| Parameter | Current | New | Rationale |
|-----------|---------|-----|-----------|
| `CROSSFADE_MS` | 25 | 75 | 50-100ms hides edit points |
| `crossfade_curve` | linear | logarithmic | Natural audio decay |
| `segment_fade_in_ms` | 0 | 15 | Prevents click at onset |
| `segment_fade_out_ms` | 0 | 25 | Matches natural tail-off |
| `comfort_noise_db` | N/A | -55 | Subtle but masks silence |

## Dependencies

- **numpy**: Required for noise generation and fade curve calculations
- **scipy.signal** (optional): Better pink noise filter if available, graceful fallback otherwise

## Verification

After implementation:
1. Run `uv run python generate_audio.py` with a test script
2. Use ffmpeg to analyze transitions:
   ```bash
   ffmpeg -i output.mp3 -af "silencedetect=noise=-40dB:d=0.1" -f null -
   ```
3. Listen to transitions - should be smooth, no abrupt cuts
4. Verify noise floor continuity:
   ```bash
   ffmpeg -i output.mp3 -ss <pause_time> -t 0.5 -af "volumedetect" -f null -
   ```
   Should show ~-55 dB during pauses instead of `-inf`

## Trade-offs

| Technique | Benefit | Cost |
|-----------|---------|------|
| Comfort noise | Natural continuity | ~0.001 dB noise floor |
| Longer crossfades | Smoother transitions | Slight blur if too long |
| Per-segment fades | No clicks | Minimal consonant softening |
| Noise analysis | Adaptive matching | Processing time |
